<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Ghi chú</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/7166/7166938.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&family=Roboto:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #fbbc05;
            --danger-color: #ea4335;
            --background-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #202124;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --note-box-margin: 10px;
            --note-box-padding: 15px;
            --note-box-height: 80px;
            --phrase-color: #1e88e5;
            --word-color: #00695c;
            --phonetic-color: #414440;
            --translation-color: #8a8a8a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            flex-direction: column;
            max-width: 100%;
            height: 100vh;
            padding: 16px;
            overflow: hidden;
        }

        .title {
            text-align: center;
            color: var(--primary-color);
            margin: 10px 0;
            font-size: 24px;
        }

        .input-controls {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 16px;
            transition: height 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .input-controls.hidden {
            height: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        .input-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #textInput {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            outline: none;
            font-family: 'Roboto', Arial, sans-serif;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 100px;
        }

        #textInput:focus {
            border-color: var(--secondary-color);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 12rem;
        }

        #postButton {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 5rem;
        }

        #postButton:hover:not(.loading) {
            background-color: #3367d6;
        }

        #postButton.loading {
            cursor: not-allowed;
            background-color: #7ba7f7;
            pointer-events: none;
        }

        #postButton .loading-spinner {
            display: none;
            border: 3px solid #a1bef3;
            border-top: 3px solid transparent;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: spin 1s linear infinite;
            margin-right: 6px;
        }

        #postButton.loading .loading-spinner {
            display: inline-block;
        }

        #postButton.loading span {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .controls-top {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .font-size-label {
            font-weight: bold;
            color: var(--text-color);
            font-size: 14px;
        }

        .font-size-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 14px;
        }

        .file-controls {
            display: flex;
            gap: 8px;
        }

        .file-button {
            padding: 8px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-button:hover {
            background-color: #2d9249;
        }

        .file-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        #fileInput {
            display: none;
        }

        .notes-area {
            flex: 1;
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 16px;
            overflow-y: auto;
        }

        #notesDisplay {
            display: flex;
            flex-direction: column;
            gap: var(--note-box-margin);
            width: 100%;
        }

        .note-box {
            position: relative;
            background-color: #e8f0fe;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: var(--note-box-padding);
            margin: 0;
            min-height: var(--note-box-height);
            margin-bottom: var(--note-box-margin);
            font-family: 'Roboto', Arial, sans-serif;
            font-weight: 800;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s;
        }

        .note-box:hover {
            background-color: #d2e3fc;
        }

        .note-top-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .note-text {
            font-weight: 600;
            flex-grow: 1;
            outline: none;
            cursor: pointer;
            white-space: pre-wrap;
            margin-bottom: 8px;
        }

        .note-text[contenteditable]:focus {
            background-color: #fff;
            border-radius: 4px;
            font-weight: 600;
            padding: 4px;
        }

        .note-meta {
            font-size: 1em;
            font-weight: 800;
            color: #267a73;
            margin-top: 3px;
            margin-bottom: 8px;
        }

        .phrase-phonetic {
            color: var(--phrase-color);
        }

        .word-phonetic {
            color: var(--word-color);
        }

        .phonetic {
            color: var(--phonetic-color);
            margin-left: 0.8em;
        }

        .translation {
            color: var(--translation-color);
            margin-left: 2.2em;
        }

        .separator {
            color: #000000;
            margin-left: 0.6em;
        }

        .note-controls {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            color: white;
            border: none;
            transition: transform 0.2s, background-color 0.2s;
        }

        .btn:hover {
            transform: scale(1.1);
        }

        .remove-btn {
            background-color: var(--danger-color);
        }

        .speak-btn {
            background-color: var(--accent-color);
        }

        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #757575;
            font-style: italic;
        }

        .toggle-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            justify-content: flex-end;
        }

        .toggle-button {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .toggle-button:hover {
            background-color: #3367d6;
        }

        .toggle-button svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        .fullscreen-button {
            padding: 4px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-button:hover {
            background-color: #2d9249;
        }

        .fullscreen-button svg {
            width: 16px;
            height: 16px;
            fill: white;
        }

        /* Media query for screens larger than 800px */
        @media (min-width: 801px) {
            .input-controls {
                flex-direction: row;
                align-items: flex-start;
                padding: 16px;
                gap: 12px;
            }

            .input-area {
                flex-grow: 1;
                width: auto;
            }

            #textInput {
                width: 100%;
                min-height: 100px;
            }

            .controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                min-width: 180px;
            }

            .controls-top {
                flex-direction: row;
                align-items: center;
                gap: 8px;
            }

            .font-control {
                order: 0;
            }

            .file-controls {
                order: 0;
                flex-direction: row;
                gap: 8px;
            }

            #postButton {
                padding: 8px 16px;
                font-size: 14px;
                min-width: 80px;
                order: 0;
            }
        }

        /* Media query for screens smaller than or equal to 800px */
        @media (max-width: 800px) {
            .container {
                padding: 8px;
            }

            .title {
                font-size: 20px;
            }

            .input-controls {
                flex-direction: column;
                padding: 12px;
                gap: 8px;
            }

            .input-area {
                display: flex;
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            #textInput {
                width: 100%;
                border-radius: var(--border-radius);
                min-height: 80px;
            }

            #postButton {
                padding: 8px 2rem;
                font-size: 12px;
                border-radius: var(--border-radius);
                margin-left: auto;
                height: auto;
                width: auto;
                min-width: 60px;
                order: 4;
            }

            .controls {
                flex-direction: row;
                align-items: center;
                margin-left: auto;
                gap: 6px;
                flex-wrap: nowrap;
                min-width: auto;
            }

            .controls-top {
                flex-direction: row;
                align-items: center;
                gap: 6px;
            }

            .font-control {
                order: 1;
            }

            .file-controls {
                order: 2;
                flex-direction: row;
                gap: 6px;
            }

            .file-button {
                width: 28px;
                height: 28px;
            }

            .file-button svg {
                width: 16px;
                height: 16px;
            }

            .font-size-input {
                width: 45px;
                font-size: 12px;
            }

            .notes-area {
                min-height: 50vh;
            }

            .note-controls {
                flex-direction: row;
                justify-content: flex-end;
            }

            .btn {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
        }

        /* Media query for screens smaller than or equal to 480px */
        @media (max-width: 480px) {
            #postButton {
                padding: 6px 12px;
                margin-left: auto;
                font-size: 11px;
                min-width: 50px;
            }

            .font-size-input {
                width: 40px;
                font-size: 11px;
            }

            .file-button {
                width: 26px;
                height: 26px;
            }

            .file-button svg {
                width: 14px;
                height: 14px;
            }

            .input-controls {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toggle-controls">
            <button id="hideInputBtn" class="toggle-button" aria-label="Ẩn thanh nhập">
                <svg viewBox="0 0 24 24">
                    <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                </svg>
                <span>Hide</span>
            </button>
            <button id="fullscreenBtn" class="fullscreen-button" aria-label="Chuyển sang chế độ toàn màn hình">
                <svg viewBox="0 0 24 24">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
            </button>
            <button id="exitFullscreenBtn" class="fullscreen-button" style="display: none;" aria-label="Thoát chế độ toàn màn hình">
                <svg viewBox="0 0 24 24">
                    <path d="M5 16h3v3H5v-3zm3-8H5v3h3V8zm11 8h-3v3h3v-3zm-3-8h3v3h-3V8z"/>
                </svg>
            </button>
        </div>
        <div class="input-controls" id="inputControls">
            <div class="input-area">
                <textarea spellcheck="false" id="textInput" placeholder="Nhập ghi chú của bạn..." aria-label="Nhập ghi chú mới"></textarea>
            </div>
            <div class="controls">
                <button id="postButton" aria-label="Đăng ghi chú">
                    <span class="loading-spinner"></span>
                    <span>Đăng</span>
                </button>
                <div class="font-control">
                    <label for="initialFontSize" class="font-size-label">Cỡ:</label>
                    <input type="number" id="initialFontSize" class="font-size-input" min="12" max="128" value="54" aria-label="Cỡ chữ mặc định">
                </div>
                <div class="file-controls">
                    <button id="exportBtn" class="file-button" aria-label="Xuất ghi chú">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                    </button>
                    <button id="importBtn" class="file-button" aria-label="Nhập ghi chú">
                        <svg viewBox="0 0 24 24">
                            <path d="M19 13h-4v6H9v-6H5l7-7 7 7zM5 4v2h14V4H5z"/>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" accept=".json" aria-label="Chọn file ghi chú để nhập">
                </div>
            </div>
        </div>
        
        <div class="notes-area" role="region" aria-label="Khu vực hiển thị ghi chú">
            <div id="notesDisplay">
                <div class="empty-state">Chưa có ghi chú nào. Hãy nhập nội dung bên trên để bắt đầu.</div>
            </div>
        </div>
    </div>

    <script>
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];

                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));

                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }

                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error('Error processing XLSX:', e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const textInput = document.getElementById('textInput');
            const postButton = document.getElementById('postButton');
            const notesDisplay = document.getElementById('notesDisplay');
            const initialFontSizeInput = document.getElementById('initialFontSize');
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const fileInput = document.getElementById('fileInput');
            const inputControls = document.getElementById('inputControls');
            const hideInputBtn = document.getElementById('hideInputBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');

            const MW_API_KEY = '41df0ea1-5bee-4925-93ed-7070a944a385'; // Thay thế bằng API key của bạn nếu cần
            const commonVerbs = new Set(['go', 'run', 'eat', 'drink', 'sleep', 'write', 'read', 'speak', 'listen', 'walk', 'be', 'have', 'do', 'say', 'get', 'make', 'know', 'think', 'take', 'see', 'come', 'want', 'look', 'use', 'find', 'give', 'tell']);
            const posAbbreviations = {
                'verb': 'v',
                'noun': 'n',
                'adjective': 'adj',
                'adverb': 'adv',
                'preposition': 'prep',
                'conjunction': 'conj',
                'pronoun': 'pron',
                'interjection': 'int'
            };

            let currentSpeech = null;
            let initialFontSize = parseInt(initialFontSizeInput.value, 10);

            initialFontSizeInput.addEventListener('change', () => {
                initialFontSize = parseInt(initialFontSizeInput.value, 10);
                saveNotes(); // Lưu lại cỡ chữ mặc định mới
            });

            async function fetchTranslation(text) {
                if (!text || /^\s*$/.test(text)) return ''; // Bỏ qua nếu text rỗng hoặc chỉ có khoảng trắng
                try {
                    const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(text)}`);
                    if (response.ok) {
                        const data = await response.json();
                        return data[0].map(item => item[0]).join('');
                    } else {
                        console.warn(`Google Translate API failed for "${text}": ${response.status}`);
                        return '';
                    }
                } catch (error) {
                    console.warn(`Google Translate API error for "${text}":`, error);
                    return '';
                }
            }

            async function fetchWordData(text) {
                let phonetic = '';
                let pos = '';
                let translation = '';

                // API 1: Free Dictionary API (cho phiên âm)
                try {
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(text)}`);
                    if (response.ok) {
                        const data = await response.json();
                        const entry = data[0];
                        phonetic = entry.phonetic || (entry.phonetics?.find(p => p.text)?.text) || '';
                        phonetic = phonetic.replace(/^\/|\/$/g, ''); // Bỏ dấu / ở đầu và cuối
                    } else {
                        console.warn(`Free Dictionary API failed for "${text}": ${response.status}`);
                    }
                } catch (error) {
                    console.warn(`Free Dictionary API error for "${text}":`, error);
                }

                // API 2: Merriam-Webster (cho loại từ - part of speech) - chỉ cho từ đơn
                if (!text.includes(' ')) { // Chỉ gọi API này nếu là một từ đơn
                    try {
                        const response = await fetch(`https://www.dictionaryapi.com/api/v3/references/collegiate/json/${text}?key=${MW_API_KEY}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.length > 0 && typeof data[0] === 'object') { // Kiểm tra data[0] là object
                                let entry = data[0];
                                // Ưu tiên tìm 'verb' nếu từ đó nằm trong commonVerbs
                                if (commonVerbs.has(text.toLowerCase())) {
                                    const verbEntry = data.find(item => typeof item === 'object' && item.fl === 'verb');
                                    if (verbEntry) entry = verbEntry;
                                }
                                pos = posAbbreviations[entry.fl] || entry.fl || '';
                            } else if (data && data.length > 0 && typeof data[0] === 'string') {
                                console.warn(`Merriam-Webster API for "${text}" returned suggestions: ${data.slice(0,3).join(', ')}`);
                            }
                        } else {
                            console.warn(`Merriam-Webster API failed for "${text}": ${response.status}`);
                        }
                    } catch (error) {
                        console.warn(`Merriam-Webster API error for "${text}":`, error);
                    }
                }

                // API 3: Google Translate (cho bản dịch tiếng Việt)
                translation = await fetchTranslation(text);

                return { phonetic, pos, translation };
            }


            async function fetchNoteData(text) {
                const trimmedText = text.trim();
                if (!trimmedText) return { phrase: {}, words: {} }; // Trả về rỗng nếu không có text

                const periodCount = (trimmedText.match(/\./g) || []).length;
                const wordCount = trimmedText.split(/\s+/).filter(word => word.match(/^[a-zA-Z'-]+$/)).length; // Cho phép dấu nháy đơn và gạch nối trong từ

                // Chỉ lấy dữ liệu chi tiết nếu là cụm từ ngắn hoặc một câu đơn giản
                if (periodCount > 1 || wordCount > 7) { // Tăng giới hạn từ lên một chút
                    const phraseTranslation = await fetchTranslation(trimmedText);
                    return { phrase: { translation: phraseTranslation }, words: {} };
                }

                const wordData = { phrase: {}, words: {} };

                // Lấy dữ liệu cho cả cụm từ
                wordData.phrase = await fetchWordData(trimmedText);

                // Lấy dữ liệu cho từng từ (nếu là cụm từ)
                if (wordCount > 1) {
                    const words = trimmedText.split(/\s+/).filter(word => word.match(/^[a-zA-Z'-]+$/));
                    for (const word of words) {
                        const cleanedWord = word.toLowerCase().replace(/[^a-z'-]/g, ''); // Loại bỏ ký tự không phải chữ cái, nháy đơn, gạch nối
                        if (cleanedWord) {
                            const wordInfo = await fetchWordData(cleanedWord);
                            wordData.words[cleanedWord] = { phonetic: wordInfo.phonetic, pos: wordInfo.pos };
                        }
                    }
                }
                return wordData;
            }

            function updateNoteMeta(noteBox, wordData) {
                const noteMeta = noteBox.querySelector('.note-meta');
                if (!noteMeta) return;

                noteMeta.innerHTML = ''; // Xóa nội dung cũ

                const { phrase, words } = wordData;

                if (phrase && (phrase.phonetic || phrase.pos || phrase.translation)) {
                    let phraseHtml = `<span class="phrase-phonetic">`;
                    if (phrase.pos) phraseHtml += `(${phrase.pos}) `;
                    if (phrase.phonetic) phraseHtml += `/${phrase.phonetic}/`;
                    phraseHtml += `</span>`;
                    if (phrase.translation) {
                        phraseHtml += `<span class="separator">–</span><span class="translation">${phrase.translation}</span>`;
                    }
                    noteMeta.innerHTML += `<div>${phraseHtml}</div>`;
                }


                const wordsArray = Object.entries(words);
                if (wordsArray.length > 0) {
                    wordsArray.forEach(([word, data]) => {
                        if (data.phonetic || data.pos) {
                            let wordHtml = `<div><span class="word-phonetic">${word}`;
                            if (data.pos) wordHtml += ` (${data.pos})`;
                            if (data.phonetic) wordHtml += `<span class="phonetic">/${data.phonetic}/</span>`;
                            wordHtml += `</span></div>`;
                            noteMeta.innerHTML += wordHtml;
                        }
                    });
                }

                if (noteMeta.innerHTML.trim() === '') {
                     if (phrase && phrase.translation) { // Trường hợp chỉ có bản dịch cho cụm dài
                        noteMeta.innerHTML = `<div><span class="translation">${phrase.translation}</span></div>`;
                    } else {
                        noteMeta.textContent = 'Không có thông tin bổ sung.';
                     }
                }
            }


            function addNoteBox(text, fontSize, existingWordData = null, shouldFetch = true) {
                removeEmptyState();
                const noteBox = document.createElement('div');
                noteBox.className = 'note-box';
                noteBox.dataset.text = text;
                noteBox.dataset.fontSize = fontSize;
                noteBox.dataset.isSpeaking = 'false';


                const noteTopControls = document.createElement('div');
                noteTopControls.className = 'note-top-controls';

                const fontSizeControl = document.createElement('div');
                fontSizeControl.className = 'font-size-control';

                const fontSizeLabel = document.createElement('label');
                fontSizeLabel.className = 'font-size-label';
                fontSizeLabel.textContent = 'Cỡ:';
                const uniqueId = `fontSize-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                fontSizeLabel.htmlFor = uniqueId;

                const fontSizeInput = document.createElement('input');
                fontSizeInput.className = 'font-size-input';
                fontSizeInput.type = 'number';
                fontSizeInput.min = '12';
                fontSizeInput.max = '128';
                fontSizeInput.value = fontSize;
                fontSizeInput.id = uniqueId;
                fontSizeInput.setAttribute('aria-label', 'Cỡ chữ của ghi chú');

                const noteTextSpan = document.createElement('span'); // Sẽ được định nghĩa sau

                fontSizeInput.addEventListener('input', () => {
                    const newSize = fontSizeInput.value;
                    noteTextSpan.style.fontSize = `${newSize}px`;
                    noteBox.dataset.fontSize = newSize;
                    saveNotes();
                });
                fontSizeInput.addEventListener('change', () => { // Đảm bảo lưu khi focus out
                     const newSize = fontSizeInput.value;
                    noteTextSpan.style.fontSize = `${newSize}px`;
                    noteBox.dataset.fontSize = newSize;
                    saveNotes();
                });


                fontSizeControl.appendChild(fontSizeLabel);
                fontSizeControl.appendChild(fontSizeInput);

                const noteControls = document.createElement('div');
                noteControls.className = 'note-controls';

                const speakBtn = document.createElement('button');
                speakBtn.className = 'btn speak-btn';
                speakBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>';
                speakBtn.title = 'Đọc ghi chú';
                speakBtn.setAttribute('aria-label', 'Đọc ghi chú');
                speakBtn.addEventListener('click', () => {
                    if (noteBox.dataset.isSpeaking === 'true') {
                        stopSpeaking(noteBox, speakBtn);
                    } else {
                        speakNote(noteBox.dataset.text, noteBox, speakBtn);
                    }
                });

                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn remove-btn';
                removeBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="18px" height="18px"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>';
                removeBtn.title = 'Xóa ghi chú';
                removeBtn.setAttribute('aria-label', 'Xóa ghi chú');
                removeBtn.addEventListener('click', () => {
                    stopSpeaking(noteBox, speakBtn); // Dừng đọc nếu đang đọc
                    notesDisplay.removeChild(noteBox);
                    if (notesDisplay.children.length === 0 || (notesDisplay.children.length === 1 && notesDisplay.firstChild.classList.contains('empty-state'))) {
                        showEmptyState();
                    }
                    saveNotes();
                });

                noteControls.appendChild(speakBtn);
                noteControls.appendChild(removeBtn);

                noteTopControls.appendChild(fontSizeControl);
                noteTopControls.appendChild(noteControls);

                noteTextSpan.className = 'note-text';
                noteTextSpan.spellcheck = false;
                noteTextSpan.textContent = text;
                noteTextSpan.contentEditable = false; // Ban đầu không cho sửa
                noteTextSpan.style.fontSize = `${fontSize}px`;
                noteTextSpan.setAttribute('aria-label', 'Nội dung ghi chú, nhấp đúp để chỉnh sửa');

                noteTextSpan.addEventListener('dblclick', () => {
                    noteTextSpan.contentEditable = true;
                    noteTextSpan.focus();
                     // Lưu trạng thái trước khi sửa để có thể khôi phục nếu cần
                    noteTextSpan.dataset.originalText = noteTextSpan.textContent;
                });

                noteTextSpan.addEventListener('blur', async () => {
                    noteTextSpan.contentEditable = false;
                    const newText = noteTextSpan.textContent.trim();
                    const oldText = noteBox.dataset.text;

                    if (newText === oldText) return; // Không có thay đổi thì không làm gì

                    noteBox.dataset.text = newText;
                    if (newText) {
                        noteMeta.textContent = 'Đang tải...';
                        const newWordData = await fetchNoteData(newText);
                        noteBox.dataset.wordData = JSON.stringify(newWordData);
                        updateNoteMeta(noteBox, newWordData);
                    } else {
                        // Nếu xóa hết text, xóa luôn wordData và meta
                        noteBox.dataset.wordData = JSON.stringify({ phrase: {}, words: {} });
                        updateNoteMeta(noteBox, { phrase: {}, words: {} });
                    }
                    saveNotes();
                });

                noteTextSpan.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        noteTextSpan.blur(); // Trigger blur để lưu và fetch data
                    } else if (e.key === 'Escape') {
                        noteTextSpan.textContent = noteTextSpan.dataset.originalText || noteBox.dataset.text; // Khôi phục text cũ
                        noteTextSpan.contentEditable = false;
                        noteTextSpan.blur(); // Bỏ focus
                    }
                });


                const noteMeta = document.createElement('div');
                noteMeta.className = 'note-meta';

                noteBox.appendChild(noteTopControls);
                noteBox.appendChild(noteTextSpan);
                noteBox.appendChild(noteMeta);

                if (existingWordData) {
                    noteBox.dataset.wordData = JSON.stringify(existingWordData);
                    updateNoteMeta(noteBox, existingWordData);
                } else if (shouldFetch && text) {
                    noteMeta.textContent = 'Đang tải...';
                    fetchNoteData(text).then(wordData => {
                        noteBox.dataset.wordData = JSON.stringify(wordData);
                        updateNoteMeta(noteBox, wordData);
                        saveNotes(); // Lưu sau khi fetch xong lần đầu
                    }).catch(error => {
                        console.error("Error fetching note data on add:", error);
                        noteMeta.textContent = 'Lỗi tải dữ liệu.';
                         saveNotes(); // Vẫn lưu ghi chú dù có lỗi fetch
                    });
                } else if (!text) { // Trường hợp text rỗng ngay từ đầu
                    noteBox.dataset.wordData = JSON.stringify({ phrase: {}, words: {} });
                    updateNoteMeta(noteBox, { phrase: {}, words: {} });
                }


                notesDisplay.insertBefore(noteBox, notesDisplay.firstChild);
            }

            function speakNote(text, noteBox, speakButton) {
                if (currentSpeech) { // Dừng bất kỳ bài phát biểu nào đang diễn ra
                    speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US'; // Thiết lập ngôn ngữ

                utterance.onstart = () => {
                    noteBox.dataset.isSpeaking = 'true';
                    speakButton.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>'; // Pause icon
                    speakButton.title = 'Dừng đọc';
                };

                utterance.onend = () => {
                    noteBox.dataset.isSpeaking = 'false';
                    speakButton.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>'; // Speak icon
                    speakButton.title = 'Đọc ghi chú';
                    currentSpeech = null;
                };

                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event.error);
                    noteBox.dataset.isSpeaking = 'false';
                    speakButton.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>'; // Speak icon
                    speakButton.title = 'Đọc ghi chú';
                    currentSpeech = null;
                };

                currentSpeech = utterance;
                speechSynthesis.speak(utterance);
            }

            function stopSpeaking(noteBox, speakButton) {
                speechSynthesis.cancel();
                if (noteBox) noteBox.dataset.isSpeaking = 'false';
                if (speakButton) {
                     speakButton.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>'; // Speak icon
                     speakButton.title = 'Đọc ghi chú';
                }
                currentSpeech = null;
            }

            function showEmptyState() {
                if (!notesDisplay.querySelector('.empty-state')) {
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state';
                    emptyState.textContent = 'Chưa có ghi chú nào. Hãy nhập nội dung bên trên để bắt đầu.';
                    notesDisplay.appendChild(emptyState);
                }
            }

            function removeEmptyState() {
                const emptyState = notesDisplay.querySelector('.empty-state');
                if (emptyState) {
                    notesDisplay.removeChild(emptyState);
                }
            }

            function saveNotes() {
                const notes = [];
                document.querySelectorAll('.note-box').forEach(noteBox => {
                    try {
                        const wordData = JSON.parse(noteBox.dataset.wordData);
                        notes.push({
                            text: noteBox.dataset.text,
                            fontSize: noteBox.dataset.fontSize,
                            wordData: wordData
                        });
                    } catch (e) {
                        console.error("Error parsing wordData during save for note:", noteBox.dataset.text, e);
                        // Lưu ghi chú mà không có wordData nếu có lỗi
                         notes.push({
                            text: noteBox.dataset.text,
                            fontSize: noteBox.dataset.fontSize,
                            wordData: { phrase: {}, words: {} } // Hoặc một giá trị mặc định an toàn
                        });
                    }
                });
                localStorage.setItem('notesApp', JSON.stringify({
                    notes: notes,
                    initialFontSize: initialFontSize // Lưu cả cỡ chữ mặc định
                }));
            }

            function loadNotes() {
                const data = localStorage.getItem('notesApp');
                if (data) {
                    const parsedData = JSON.parse(data);
                    if (parsedData.initialFontSize) {
                        initialFontSize = parseInt(parsedData.initialFontSize, 10);
                        initialFontSizeInput.value = initialFontSize;
                    }
                    if (parsedData.notes && parsedData.notes.length > 0) {
                        parsedData.notes.forEach(note => {
                            addNoteBox(note.text, parseInt(note.fontSize, 10), note.wordData, false); // false để không fetch lại
                        });
                        removeEmptyState();
                    } else {
                        showEmptyState();
                    }
                } else {
                    showEmptyState();
                }
            }

            postButton.addEventListener('click', async () => {
                const text = textInput.value.trim();
                if (text) {
                    postButton.classList.add('loading');
                    postButton.disabled = true;
                    try {
                        // Không cần fetchNoteData ở đây nữa, nó sẽ được gọi trong addNoteBox
                        addNoteBox(text, initialFontSize, null, true); // true để fetch data cho note mới
                        textInput.value = '';
                        saveNotes(); // Lưu sau khi thêm thành công
                    } catch (error) {
                        console.error("Error posting note:", error);
                        // Có thể thêm thông báo lỗi cho người dùng ở đây
                    } finally {
                        postButton.classList.remove('loading');
                        postButton.disabled = false;
                        textInput.focus();
                    }
                }
            });

            textInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    postButton.click();
                }
            });

            exportBtn.addEventListener('click', () => {
                const data = localStorage.getItem('notesApp');
                if (data) {
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'notes_backup.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('Không có ghi chú nào để xuất!');
                }
            });

            importBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedDataString = e.target.result;
                            // Kiểm tra xem có phải là file từ Google Sheet được xử lý bởi hàm loadFileData không
                            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                                gk_isXlsx = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
                                gk_fileData[file.name] = btoa(importedDataString); // Giả sử file excel/csv đọc dưới dạng binary string
                                const csvData = loadFileData(file.name);
                                if (csvData) {
                                    // Xử lý csvData thành dạng notes
                                    // Đây là một ví dụ đơn giản, bạn cần điều chỉnh cho phù hợp với cấu trúc file CSV của bạn
                                    const rows = csvData.split('\n');
                                    const notesToImport = rows.slice(1) // Bỏ qua header
                                        .map(row => {
                                            const columns = row.split(',');
                                            return columns[0] ? columns[0].trim() : null; // Giả sử cột đầu tiên là nội dung note
                                        })
                                        .filter(text => text);

                                    if (notesToImport.length > 0) {
                                        if (confirm(`Bạn có muốn nhập ${notesToImport.length} ghi chú từ file ${file.name} không? Các ghi chú hiện tại sẽ được giữ lại.`)) {
                                            notesToImport.forEach(text => addNoteBox(text, initialFontSize, null, true));
                                            saveNotes();
                                            alert('Nhập ghi chú thành công!');
                                        }
                                    } else {
                                        alert('Không tìm thấy dữ liệu ghi chú hợp lệ trong file.');
                                    }
                                } else {
                                    alert('Không thể xử lý file Excel/CSV.');
                                }

                            } else if (file.name.endsWith('.json')) { // Xử lý file JSON backup
                                const importedData = JSON.parse(importedDataString);
                                if (importedData && importedData.notes) {
                                     if (confirm('Bạn có muốn nhập các ghi chú từ file này không? Các ghi chú hiện tại sẽ được XÓA và thay thế bằng dữ liệu mới.')) {
                                        notesDisplay.innerHTML = ''; // Xóa các ghi chú hiện tại
                                        localStorage.setItem('notesApp', importedDataString); // Lưu trực tiếp dữ liệu mới
                                        loadNotes(); // Tải lại từ dữ liệu vừa import
                                        alert('Nhập ghi chú thành công!');
                                    }
                                } else {
                                    alert('File JSON không hợp lệ.');
                                }
                            } else {
                                alert('Loại file không được hỗ trợ. Vui lòng chọn file .json, .xlsx, .xls hoặc .csv.');
                            }
                        } catch (error) {
                            console.error('Lỗi khi nhập file:', error);
                            alert('Đã xảy ra lỗi khi nhập file. Vui lòng kiểm tra console.');
                        } finally {
                            fileInput.value = ''; // Reset file input
                        }
                    };
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        reader.readAsBinaryString(file); // Đọc file excel dạng binary
                    } else {
                        reader.readAsText(file); // Đọc file json/csv dạng text
                    }
                }
            });


            hideInputBtn.addEventListener('click', () => {
                inputControls.classList.toggle('hidden');
                const icon = hideInputBtn.querySelector('svg');
                const span = hideInputBtn.querySelector('span');
                if (inputControls.classList.contains('hidden')) {
                    icon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>'; // Show icon
                    span.textContent = 'Show';
                    hideInputBtn.setAttribute('aria-label', 'Hiện thanh nhập');
                } else {
                    icon.innerHTML = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>'; // Hide icon
                    span.textContent = 'Hide';
                    hideInputBtn.setAttribute('aria-label', 'Ẩn thanh nhập');
                }
            });

            function toggleFullScreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    fullscreenBtn.style.display = 'none';
                    exitFullscreenBtn.style.display = 'flex';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        fullscreenBtn.style.display = 'flex';
                        exitFullscreenBtn.style.display = 'none';
                    }
                }
            }

            fullscreenBtn.addEventListener('click', toggleFullScreen);
            exitFullscreenBtn.addEventListener('click', toggleFullScreen);

            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    fullscreenBtn.style.display = 'flex';
                    exitFullscreenBtn.style.display = 'none';
                } else {
                    fullscreenBtn.style.display = 'none';
                    exitFullscreenBtn.style.display = 'flex';
                }
            });


            // Load notes from localStorage when the page loads
            loadNotes();
            textInput.focus(); // Focus vào text input khi tải trang
        });
    </script>
</body>
</html>
